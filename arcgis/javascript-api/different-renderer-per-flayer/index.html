<!DOCTYPE html>
<html>
<head>
   <meta charset="utf-8">
   <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
   <title>Create a FeatureLayer with client side graphics - 4.7</title>
   <style>
      html,
      body,
      #viewDiv {
         padding: 0;
         margin: 0;
         height: 100%;
         width: 100%;
      }

      #infoDiv {
         position: absolute;
         bottom: 15px;
         right: 0;
         max-height: 80%;
         max-width: 300px;
         background-color: black;
         padding: 8px;
         border-top-left-radius: 5px;
         color: white;
         opacity: 0.8;
      }
   </style>

   <link rel="stylesheet" href="https://js.arcgis.com/4.7/esri/css/main.css">
   <script src="https://js.arcgis.com/4.7/"></script>

   <script>
      require([
         "esri/views/MapView",
         "esri/Map",
         "esri/layers/FeatureLayer",
         "esri/geometry/Point",
         "esri/widgets/Legend",
         "esri/renderers/SimpleRenderer",
         "esri/symbols/SimpleMarkerSymbol",
         "esri/request",
         "dojo/domReady!"
         ], function(MapView, Map, FeatureLayer, Point, Legend, SimpleRenderer, SimpleMarkerSymbol, esriRequest) {

            var legend;
            // Layers
            var completeLyr, incompleteLyr, snapped_completeLyr, snapped_incompleteLyr;

            /**************************************************
            * Define the specification for each field to create
            * in the layer
            **************************************************/

            var fields = [
            {
               name: "ObjectID",
               alias: "ObjectID",
               type: "oid"
            }, {
               name: "completed",
               alias: "completed",
               type: "string"
            },
            {
               name: "lat",
               alias: "lat",
               type: "number"
            },
            {
               name: "lng",
               alias: "lng",
               type: "number"
            }];

            /**************************************************
            * Create the map and view
            **************************************************/

            var map = new Map({
               //basemap: "streets-night-vector", // roads seem misaligned with google GPS locations
               //basemap: "osm",
               //basemap: "dark-gray-vector" // roads seem misaligned with google GPS locations
               //basemap: "dark-gray" // slightly better, but pixelated when zoom in
               //basemap: "streets", // still not as good as osm
               basemap: "hybrid", // looks pretty nice
               //basemap: "streets-navigation-vector" // same as dark-gray-vector
               //ground: "world-elevation"
            });

            // Create MapView
            var view = new MapView({
               container: "viewDiv",
               map: map,
               center: [-121.6555013,36.6777372],
               zoom: 13
            });

            /**************************************************
            * Define the renderer for symbolizing earthquakes
            **************************************************/

            var redPointsRenderer = new SimpleRenderer({
               symbol: {
                  type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                  url: "./transparent-markers/red.png",
                  width: "20px",
                  height: "20px"
               }
            });

            var orangePointsRenderer = new SimpleRenderer({
               symbol: {
                  type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                  url: "./transparent-markers/orange.png",
                  width: "20px",
                  height: "20px"
               }
            });

            var tealPointsRenderer = new SimpleRenderer({
               symbol: {
                  type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                  url: "./transparent-markers/teal.png",
                  width: "20px",
                  height: "20px"
               }
            });

            var bluePointsRenderer = new SimpleRenderer({
               symbol: {
                  type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                  url: "./transparent-markers/blue.png",
                  width: "20px",
                  height: "20px"
               }
            });

            view.when(function() {
               // Request the earthquake data from USGS when the view resolves
               getData()
               .then(createLayersFromData)
               .catch(errback);
            });

            // Request the earthquake data
            function getData() {

               var url = "snapCoordinates.json";

               return esriRequest(url, {
                  responseType: "json"
               });
            }

            function createLayersFromData(response){
               var geoJson = response.data;

               completeLyr = createLayer([], bluePointsRenderer);
               incompleteLyr = createLayer([], redPointsRenderer);
               snapped_completeLyr = createLayer([], tealPointsRenderer);
               snapped_incompleteLyr = createLayer([], orangePointsRenderer);

               var completeLyrOid = 0, incompleteLyrOid = 0, snapped_completeLyrOid = 0, snapped_incompleteLyrOid = 0;

               for (var i=0; i<geoJson.length; i++){

                  if (geoJson[i].city != "Salinas"){
                     continue; // skip bad records
                  }

                  if (geoJson[i].formatted_address === "Salinas~ CA~ USA"){
                     continue; // skip vague records
                  }

                  if (geoJson[i].completed === "COMPLETED"){
                     addPointToLayer(completeLyr, geoJson[i].long, geoJson[i].lat, ++completeLyrOid);
                     addPointToLayer(snapped_completeLyr, geoJson[i].snapped_long, geoJson[i].snapped_lat, ++snapped_completeLyrOid);
                  }else{
                     addPointToLayer(incompleteLyr, geoJson[i].long, geoJson[i].lat, ++incompleteLyrOid);
                     addPointToLayer(snapped_incompleteLyr, geoJson[i].snapped_long, geoJson[i].snapped_lat, ++snapped_incompleteLyrOid);
                  }
               }

               createLegend(completeLyr, incompleteLyr, snapped_completeLyr, snapped_incompleteLyr);
            }

            /**************************************************
            * Add point to FeatureLayer given coordinates and ObjectID
            **************************************************/

            function addPointToLayer(layer, pointX, pointY, pointObjectID){
               layer.source.add({
                  geometry: new Point({
                     x: pointX,
                     y: pointY
                  }),
                  attributes: {
                     ObjectID: pointObjectID,
                     lat: pointY,
                     lng: pointX
                  }
               });
            }

            /**************************************************
            * Create a FeatureLayer with the array of graphics
            **************************************************/

            function createLayer(graphics, layerRenderer) {

               lyr = new FeatureLayer({
                  source: graphics, // autocast as an array of esri/Graphic
                  // create an instance of esri/layers/support/Field for each field object
                  fields: fields, // This is required when creating a layer from Graphics
                  objectIdField: "ObjectID", // This must be defined when creating a layer from Graphics
                  renderer: layerRenderer, // set the visualization on the layer
                  spatialReference: {
                     wkid: 4326
                  },
                  geometryType: "point" // Must be set when creating a layer from Graphics
                  //popupTemplate: pTemplate
               });

               map.add(lyr);

               return lyr;
            }

            /******************************************************************
            * Add layer to layerInfos in the legend
            ******************************************************************/

            function createLegend(completeLyr, incompleteLyr, snapped_completeLyr, snapped_incompleteLyr) {
               // if the legend already exists, then update it with the new layer

               if (legend) {
                  legend.layerInfos = [
                     {
                        layer: completeLyr,
                        title: "Completed (Original)"
                     },
                     {
                        layer: incompleteLyr,
                        title: "Incomplete (Original)"
                     },
                     {
                        layer: snapped_completeLyr,
                        title: "Completed (Snapped to Street)"
                     },
                     {
                        layer: snapped_incompleteLyr,
                        title: "Incomplete (Snapped to Street)"
                     }
                  ];
               }else{
                  legend = new Legend({
                     view: view,
                     layerInfos: [
                        {
                           layer: completeLyr,
                           title: "Completed (Original)"
                        },
                        {
                           layer: incompleteLyr,
                           title: "Incomplete (Original)"
                        },
                        {
                           layer: snapped_completeLyr,
                           title: "Completed (Snapped to Street)"
                        },
                        {
                           layer: snapped_incompleteLyr,
                           title: "Incomplete (Snapped to Street)"
                        }
                     ]
                  }, "infoDiv");
               }
            }

            // Executes if data retrieval was unsuccessful.
            function errback(error) {
               console.error("Creating legend failed. ", error);
            }

         });
   </script>
</head>

<body>
   <div id="viewDiv"></div>
   <div id="infoDiv">
      <h2>Sidewalk/Gutter Repair</h2>
   </div>
</body>
</html>